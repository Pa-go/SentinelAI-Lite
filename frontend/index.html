<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelAI | Elite Neural Command</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@300;500;800&display=swap');

        :root {
            --neon-blue: #00d4ff;
            --neon-green: #00ff99;
            --neon-red: #ff0055;
            --neon-yellow: #f1c40f;
            --bg-black: #050507;
            --glass-bg: rgba(0, 10, 20, 0.85);
            --panel-shadow: 0 0 25px rgba(0, 212, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: default; }

        body, html {
            width: 100%; height: 100%; overflow-x: hidden;
            background: var(--bg-black); font-family: 'JetBrains Mono', monospace; color: #fff;
        }

        #canvas-container { position: fixed; inset: 0; z-index: 1; pointer-events: none; }

        .crt-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            background-size: 100% 2px, 2px 100%; z-index: 6000; pointer-events: none; opacity: 0.5;
        }

        .glass {
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 212, 255, 0.15); box-shadow: var(--panel-shadow);
            border-radius: 4px; transition: all 0.3s ease;
        }

        /* --- SIDEBAR DRAWER --- */
        .drawer {
            position: fixed; top: 0; left: -320px; width: 320px; height: 100%;
            z-index: 5500; padding: 30px; border-right: 2px solid var(--neon-blue);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: none; pointer-events: none;
        }
        .drawer.active-session { display: block; pointer-events: auto; }
        .drawer.open { transform: translateX(320px); }

        .side-tab {
            position: absolute; top: 50%; right: -32px; transform: translateY(-50%);
            width: 32px; height: 120px; display: flex; align-items: center; justify-content: center;
            background: rgba(0, 212, 255, 0.1); border: 1px solid var(--neon-blue); border-left: none;
            color: var(--neon-blue); font-family: 'Orbitron'; font-size: 0.65rem; letter-spacing: 2px;
            text-transform: uppercase; writing-mode: vertical-rl; text-orientation: mixed;
            cursor: pointer; pointer-events: auto; transition: opacity 0.5s ease;
        }
        .tab-hidden { opacity: 0 !important; pointer-events: none !important; }

        .drawer-header { font-family: 'Orbitron'; color: var(--neon-blue); margin-bottom: 40px; }
        .drawer-links { list-style: none; }
        .drawer-links li { margin-bottom: 20px; padding: 10px; border-bottom: 1px solid rgba(0, 212, 255, 0.1); cursor: pointer; transition: 0.3s; }
        .drawer-links li:hover { background: rgba(0, 212, 255, 0.1); padding-left: 20px; color: var(--neon-blue); }
        .dropdown-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); line-height: 1.4; }
        .dropdown-content.active { max-height: 200px; padding: 10px; margin-top: 10px; }

        /* --- INTRO & LOGIN --- */
        #introSec, #loginSec {
            position: fixed; width: 100%; height: 100vh; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 7000; transition: opacity 1s;
        }
        #introSec { background: radial-gradient(circle at center, #0a0e14 0%, #050507 100%); }
        #loginSec { z-index: 4000; opacity: 0; pointer-events: none; }
        
        .intro-bg-data { position: absolute; inset: 0; font-size: 10px; color: rgba(0, 212, 255, 0.03); white-space: pre-wrap; z-index: -1; padding: 20px; overflow: hidden; }
        .glitch { font-family: 'Orbitron'; font-size: 4rem; font-weight: 900; letter-spacing: 0.3em; color: #fff; text-shadow: 2px 2px var(--neon-red), -2px -2px var(--neon-blue); margin-bottom: 2rem; }
        
        .load-bar-container { width: 300px; height: 2px; background: rgba(0, 212, 255, 0.1); margin: 15px 0; position: relative; }
        #load-bar { height: 100%; width: 0%; background: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); }

        .login-box { padding: 40px; width: 400px; text-align: center; border-top: 4px solid var(--neon-blue); }
        input { width: 100%; background: rgba(0, 212, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.2); padding: 15px; color: #fff; font-family: 'JetBrains Mono'; outline: none; text-align: center; margin-bottom: 20px; }
        input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 212, 255, 0.2); }
        button.btn-access { width: 100%; padding: 15px; background: transparent; color: var(--neon-blue); border: 1px solid var(--neon-blue); font-family: 'Orbitron'; font-weight: 700; cursor: pointer; transition: 0.4s; }
        button.btn-access:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 30px var(--neon-blue); }
        .error-text { color: var(--neon-red); font-size: 0.7rem; display: none; margin-bottom: 10px; }

        /* --- DASHBOARD LAYOUT --- */
        #mainDash {
            opacity: 0; visibility: hidden; transition: 1.5s ease;
            max-width: 1600px; margin: auto; padding: 20px; position: relative; z-index: 10;
            display: grid;
            grid-template-areas: 
                "header header header"
                "kpi kpi kpi"
                "chart chart sidebar"
                "logs logs logs";
            grid-template-columns: 1fr 1fr 350px;
            gap: 20px;
            height: 95vh;
        }

        /* Header */
        header.hud-header { grid-area: header; display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; border-left: 5px solid var(--neon-blue); }
        .hud-title { font-family: 'Orbitron'; font-size: 1.2rem; letter-spacing: 4px; font-weight: 900; }
        .hud-status { display: flex; align-items: center; gap: 12px; font-size: 0.7rem; color: var(--neon-green); }
        .pulse { width: 8px; height: 8px; background: var(--neon-green); border-radius: 50%; box-shadow: 0 0 10px var(--neon-green); animation: pulseAnim 2s infinite; }
        @keyframes pulseAnim { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.3); } }

        /* KPI Row */
        .kpi-row { grid-area: kpi; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .cyber-card { padding: 20px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .cyber-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--neon-blue), transparent); animation: scanline 3s infinite linear; }
        @keyframes scanline { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .cyber-card small { color: var(--neon-blue); letter-spacing: 2px; font-size: 0.6rem; font-weight: 800; display: block; margin-bottom: 8px; }
        .cyber-card h2 { 
    font-size: 1.5rem; /* Slightly smaller to fit more */
    font-family: 'Orbitron';
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* Adds "..." if too long */
    max-width: 100%;
}

        /* Main Chart Area */
        .main-chart-area { grid-area: chart; padding: 25px; min-height: 400px; display: flex; flex-direction: column; }
        
        /* Sidebar Area (Risk + Modules) */
        .sidebar-area { grid-area: sidebar; display: flex; flex-direction: column; gap: 20px; }

        /* Logs Area */
        .logs-area { grid-area: logs; padding: 20px; display: flex; flex-direction: column; }
        .terminal-body { flex-grow: 1; overflow-y: auto; font-size: 0.75rem; color: #aaa; line-height: 1.6; max-height: 200px; }

        .panel-header { font-family: 'Orbitron'; font-size: 0.65rem; letter-spacing: 2px; color: var(--neon-blue); margin-bottom: 20px; border-bottom: 1px solid rgba(0, 212, 255, 0.1); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .log-entry { margin-bottom: 5px; border-left: 2px solid rgba(0, 212, 255, 0.2); padding-left: 10px; }
        .log-entry.alert { border-color: var(--neon-red); color: var(--neon-red); }
        .log-entry.success { border-color: var(--neon-green); color: var(--neon-green); }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .ctrl-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(0, 212, 255, 0.2); padding: 10px; font-size: 0.6rem; color: #fff; cursor: pointer; text-align: center; text-transform: uppercase; font-family: 'Orbitron'; transition: 0.3s; }
        .ctrl-btn:hover { background: rgba(0, 212, 255, 0.1); border-color: var(--neon-blue); }
        .ctrl-btn.active { background: var(--neon-blue); color: #000; }

        .hidden { display: none !important; }
    </style>
</head>
<body onclick="closeOnDash(event)">

    <div class="crt-overlay"></div>
    <div id="canvas-container"></div>

    <div id="sideDrawer" class="drawer glass">
        <div id="sideTab" class="side-tab tab-hidden" onclick="toggleDrawer(event)">Open</div>
        <div class="drawer-header"><span>COMMAND_MENU</span></div>
        <ul class="drawer-links">
            <li onclick="toggleDropdown(this)">
                RUN_DIAGNOSTICS 
                <div class="dropdown-content">Initiate deep-packet inspection and verify integrity of all active nodes.</div>
            </li>
            <li onclick="toggleDropdown(this)">
                ROTATE_CIPHERS 
                <div class="dropdown-content">Update encryption keys (AES-256) to prevent brute-force decryption attempts.</div>
            </li>
            <li onclick="toggleDropdown(this)">
                ISOLATE_NODES 
                <div class="dropdown-content" style="color: var(--neon-yellow);">WARNING: This will sever connections to infected sub-nets. Use only during containment protocols.</div>
            </li>
            <li onclick="toggleDropdown(this)" style="color:var(--neon-red); border-color:rgba(255,0,85,0.2)">
                INITIATE_LOCKDOWN 
                <div class="dropdown-content">CRITICAL ACTION: Hard disconnect of external gateway. System will go dark.</div>
            </li>
        </ul>
    </div>

    <section id="introSec">
        <div class="intro-bg-data" id="introData"></div>
        <h1 class="glitch">SENTINEL AI</h1>
        <div style="text-align: center;">
            <span id="loadStatus" style="font-size: 0.7rem; color: var(--neon-blue); letter-spacing: 4px;">INITIALIZING...</span>
            <div class="load-bar-container"><div id="load-bar"></div></div>
            <div id="loadPercent" style="font-size: 0.6rem; opacity: 0.5;">0%</div>
        </div>
    </section>

    <section id="loginSec">
        <div class="login-box glass">
            <h2>COMMAND_ACCESS</h2>
            <input type="url" id="urlInput" placeholder="SOURCE_LINK (https://...)" autocomplete="off">
            <div id="loginError" class="error-text">INVALID SOURCE PROTOCOL</div>
            <button class="btn-access" onclick="validateLogin()">Authenticate</button>
        </div>
    </section>

    <main id="mainDash">
        <header class="hud-header glass">
            <div class="hud-title">SENTINEL // <span style="color:var(--neon-blue)" id="userDisplay">CORE</span></div>
            <div class="hud-status"><span class="pulse"></span> <span id="sysStatus">SYSTEM: ACTIVE</span></div>
        </header>

        <div class="kpi-row">
            <div class="cyber-card glass"><small>TARGET VECTOR</small><h2 id="valLoad">--</h2></div>
            <div class="cyber-card glass"><small>THREAT ID</small><h2 id="valNodes">--</h2></div>
            <div class="cyber-card glass"><small>SESSION TIME</small><h2 id="valUptime">00:00:00</h2></div>
            <div class="cyber-card glass" id="integrityCard"><small>RISK VERDICT</small><h2 style="color: var(--neon-green);">--</h2></div>
        </div>

        <div class="main-chart-area glass">
            <div class="panel-header"><span>NEURAL CONNECTIVITY FLOW</span><span style="opacity: 0.4;">LIVE TELEMETRY</span></div>
            <div style="flex-grow: 1; position: relative;"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="sidebar-area">
            <div class="cyber-card glass" style="flex: 1;">
                <div class="panel-header">RISK ANALYSIS</div>
                <div style="height: 180px;"><canvas id="riskChart"></canvas></div>
            </div>
            <div class="cyber-card glass">
                <div class="panel-header">MODULES</div>
                <div class="controls">
                    <div class="ctrl-btn active" onclick="toggleModule(this)">FIREWALL</div>
                    <div class="ctrl-btn active" onclick="toggleModule(this)">STEALTH</div>
                    <div class="ctrl-btn" onclick="toggleModule(this)">HEURISTICS</div>
                    <div class="ctrl-btn" onclick="toggleModule(this)">AUTO-REPAIR</div>
                </div>
            </div>
        </div>

        <div class="logs-area glass">
            <div class="panel-header">ENCRYPTED SYSTEM LOGS</div>
            <div class="terminal-body" id="logStream"></div>
        </div>
    </main>

    <script>
    /* ==========================================================================
       SENTINEL AI | MERGED SYSTEM KERNEL
       ========================================================================== */

    let currentRiskScore = 0; 
    let backendLogs = [];
    
    // --- 1. SESSION TIMER VARIABLE (Use 'let' to allow reset) ---
    let systemStartTime; 

    let scene, camera, renderer, coreMesh, particles, rings = [];
    let mouseX = 0, mouseY = 0;
    let mainChart; 

    // --- SIDEBAR LOGIC ---
    function toggleDrawer(e) {
        if(e) e.stopPropagation(); 
        const drawer = document.getElementById('sideDrawer');
        const tab = document.getElementById('sideTab');
        drawer.classList.toggle('open');
        tab.innerText = drawer.classList.contains('open') ? "Close" : "Open";
    }
    
    function toggleDropdown(element) {
        event.stopPropagation();
        const dropdown = element.querySelector('.dropdown-content');
        document.querySelectorAll('.dropdown-content').forEach(d => { if (d !== dropdown) d.classList.remove('active'); });
        dropdown.classList.toggle('active');
    }
    
    function closeOnDash(e) {
        const drawer = document.getElementById('sideDrawer');
        const sideTab = document.getElementById('sideTab');
        if (drawer.classList.contains('open') && !drawer.contains(e.target) && e.target !== sideTab && !sideTab.contains(e.target)) {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('active'));
            drawer.classList.remove('open');
            sideTab.innerText = "Open";
        }
    }

    // --- 3D VISUALS ---
    function init3D() {
        const container = document.getElementById('canvas-container');
        if(!container) return;
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 3000);
        camera.position.z = 1000;
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const pGeo = new THREE.BufferGeometry();
        const pCount = 2000;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i++) pPos[i] = (Math.random() - 0.5) * 2000;
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        particles = new THREE.Points(pGeo, new THREE.PointsMaterial({ color: 0x00d4ff, size: 2, transparent: true, opacity: 0.2 }));
        scene.add(particles);

        const coreGeo = new THREE.IcosahedronGeometry(150, 1);
        const coreMat = new THREE.MeshPhongMaterial({ color: 0x00d4ff, wireframe: true, transparent: true, opacity: 0.15 });
        coreMesh = new THREE.Mesh(coreGeo, coreMat);
        scene.add(coreMesh);

        const ringRotations = [Math.PI, Math.PI / 2, (40 * Math.PI) / 180];
        for(let i=0; i<3; i++) {
            const ring = new THREE.Mesh(new THREE.TorusGeometry(220 + i*50, 0.5, 16, 100), new THREE.MeshBasicMaterial({ color: 0x00ff99, transparent: true, opacity: 0.1 }));
            ring.rotation.x = ringRotations[i];
            rings.push(ring);
            scene.add(ring);
        }
        
        const light = new THREE.PointLight(0x00d4ff, 2, 2000);
        light.position.set(0, 200, 500);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x111111));
        
        document.addEventListener('mousemove', e => {
            mouseX = (e.clientX - window.innerWidth / 2) / 100;
            mouseY = (e.clientY - window.innerHeight / 2) / 100;
        });
        animate();
    }

    function animate() {
        requestAnimationFrame(animate);
        if(particles) particles.rotation.y += 0.0005;
        if(coreMesh) coreMesh.rotation.y += 0.005;
        rings.forEach((r, i) => r.rotation.z += 0.002 * (i+1));
        if(scene) {
            scene.rotation.x += (mouseY * 0.01 - scene.rotation.x) * 0.05;
            scene.rotation.y += (mouseX * 0.01 - scene.rotation.y) * 0.05;
        }
        renderer.render(scene, camera);
    }

    // --- LOADING & MATRIX ---
    window.addEventListener('load', () => {
        init3D();
        generateMatrixEffect();
        let progress = 0;
        const bar = document.getElementById('load-bar');
        const status = document.getElementById('loadStatus');
        const percent = document.getElementById('loadPercent');
        const steps = ["HANDSHAKE...", "BYPASSING FIREWALL...", "DECRYPTING...", "SYNCING..."];
        
        const interval = setInterval(() => {
            progress += Math.random() * 5;
            if(progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('introSec').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('introSec').classList.add('hidden');
                        const login = document.getElementById('loginSec');
                        login.style.opacity = '1';
                        login.style.pointerEvents = 'auto';
                    }, 1000);
                }, 500);
            }
            if(bar) bar.style.width = progress + '%';
            if(percent) percent.innerText = Math.floor(progress) + '%';
            if(status) status.innerText = steps[Math.floor(progress/26)] || "ACCESSING GATEWAY...";
        }, 50);
    });

    function generateMatrixEffect() {
        const container = document.getElementById('introData');
        const chars = "0101XYZ{}[]<>/\\$#@!*";
        setInterval(() => {
            let str = "";
            for(let i=0; i<1000; i++) str += chars[Math.floor(Math.random()*chars.length)] + (i%50===0?"\n":"");
            if(container) container.innerText = str;
        }, 100);
    }

    // --- BACKEND CONNECTION ---
   // --- BACKEND CONNECTION & SMART SIDEBAR ---
    async function validateLogin() {
        const urlInput = document.getElementById('urlInput').value;
        const error = document.getElementById('loginError');
        const btn = document.querySelector('.btn-access');

        if (!urlInput) { if(error) { error.innerText = "SOURCE REQUIRED"; error.style.display = "block"; } return; }
        if(btn) btn.innerText = "SCANNING...";
        if(error) error.style.display = "none";

        try {
            const response = await fetch("http://127.0.0.1:5000/predict", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: urlInput })
            });
            const data = await response.json();
            currentRiskScore = data.raw_score;
            backendLogs = data.logs;

            // Update Header & KPI
            const userDisplay = document.getElementById('userDisplay');
            if(userDisplay) userDisplay.innerText = data.userDisplay; 
            const sysStatus = document.getElementById('sysStatus');
            if(sysStatus) sysStatus.innerText = data.sysStatus;     

            const boxLoad = document.getElementById('valLoad');
            if(boxLoad) {
                // Fix for long text: Just show the Target Name, not "TARGET: ..." prefix if it's too long
                boxLoad.innerText = data.userDisplay; 
                boxLoad.title = data.userDisplay; // Tooltip shows full text
            }
            const boxNodes = document.getElementById('valNodes');
            if(boxNodes) boxNodes.innerText = data.valNodes;
            const boxIntegrity = document.querySelector('#integrityCard h2');
            if(boxIntegrity) boxIntegrity.innerText = data.valLoad;

            // COLOR THEME & SIDEBAR LOGIC
            if(data.raw_score > 50) {
                // MALICIOUS MODE
                document.documentElement.style.setProperty('--neon-blue', '#ff0055');
                document.documentElement.style.setProperty('--neon-green', '#ff0055');
                updateSidebar('threat'); // <--- NEW: Switch Sidebar to War Mode
            } else {
                // SAFE MODE
                document.documentElement.style.setProperty('--neon-blue', '#00d4ff');
                document.documentElement.style.setProperty('--neon-green', '#00ff99');
                updateSidebar('safe');   // <--- NEW: Switch Sidebar to Peace Mode
            }
            enterDashboard(data.risk_data);
        } catch (err) {
            console.error("Connection Error:", err);
            if(error) { error.innerText = "SERVER DISCONNECTED"; error.style.display = "block"; }
            if(btn) btn.innerText = "RETRY";
        }
    }

    // --- NEW FUNCTION: DYNAMIC SIDEBAR CONTENT ---
    function updateSidebar(mode) {
        const list = document.querySelector('.drawer-links');
        if(mode === 'threat') {
            // RED MODE: Aggressive Countermeasures
            list.innerHTML = `
                <li onclick="toggleDropdown(this)" style="color:var(--neon-yellow)">
                    ISOLATE_NODES 
                    <div class="dropdown-content">WARNING: Severs connection to infected subnets.</div>
                </li>
                <li onclick="toggleDropdown(this)">
                    TRACE_ORIGIN 
                    <div class="dropdown-content">Backtrace IP through proxy chains to identify attacker.</div>
                </li>
                <li onclick="toggleDropdown(this)">
                    DEPLOY_DECOY 
                    <div class="dropdown-content">Spin up honeypot server to distract attacker.</div>
                </li>
                <li onclick="toggleDropdown(this)" style="color:var(--neon-red); border-color:rgba(255,0,85,0.5)">
                    INITIATE_LOCKDOWN 
                    <div class="dropdown-content">CRITICAL: Hard disconnect of external gateway.</div>
                </li>
            `;
        } else {
            // GREEN MODE: Maintenance Tools
            list.innerHTML = `
                <li onclick="toggleDropdown(this)">
                    RUN_DIAGNOSTICS 
                    <div class="dropdown-content">Verify integrity of all active neural nodes.</div>
                </li>
                <li onclick="toggleDropdown(this)">
                    OPTIMIZE_TRAFFIC 
                    <div class="dropdown-content">Re-balance load across healthy server clusters.</div>
                </li>
                <li onclick="toggleDropdown(this)">
                    ROTATE_CIPHERS 
                    <div class="dropdown-content">Update AES-256 encryption keys.</div>
                </li>
                <li onclick="toggleDropdown(this)">
                    VIEW_AUDIT_LOGS 
                    <div class="dropdown-content">Review access history for the past 24 hours.</div>
                </li>
            `;
        }
    }
    // --- DASHBOARD ENTRY ---
    function enterDashboard(pieData) {
        const login = document.getElementById('loginSec');
        const dash = document.getElementById('mainDash');
        const drawer = document.getElementById('sideDrawer');
        const tab = document.getElementById('sideTab');

        login.style.opacity = '0';
        setTimeout(() => {
            login.classList.add('hidden');
            drawer.classList.add('active-session');
            dash.style.visibility = 'visible';
            dash.style.opacity = '1';
            if(coreMesh) coreMesh.material.opacity = 0.05;
            rings.forEach(r => r.material.opacity = 0.05);
            
            // --- 2. RESET TIMER HERE (Start from 00:00:00) ---
            systemStartTime = Date.now(); 

            initCharts(pieData);
            startDynamicUpdates();

            setTimeout(() => {
                if(tab) tab.classList.remove('tab-hidden');
                if(drawer) drawer.classList.add('open');
                if(tab) tab.innerText = "Close";
                setTimeout(() => {
                    if(drawer) drawer.classList.remove('open');
                    if(tab) tab.innerText = "Open";
                }, 3000);
            }, 1000);
        }, 800);
    }

    // --- CHARTS & UPDATES ---
    function initCharts(pieData) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const chartColor = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();

        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(20).fill(''),
                datasets: [{
                    data: Array(20).fill(0).map(() => Math.random() * 30 + 10),
                    borderColor: chartColor,
                    backgroundColor: 'rgba(0, 212, 255, 0.05)',
                    fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, max: 100, min: 0 } },
                animation: false
            }
        });

        new Chart(document.getElementById('riskChart'), {
            type: 'doughnut',
            data: {
                labels: ['Safe', 'Alert', 'Threat'],
                datasets: [{
                    data: pieData || [70, 20, 10], 
                    backgroundColor: ['#00ff99', '#f1c40f', '#ff0055'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '80%' }
        });
    }

    function startDynamicUpdates() {
        const logs = document.getElementById('logStream');

        // 1. PRINT REAL CRITICAL LOGS FROM PYTHON
        if (backendLogs && backendLogs.length > 0) {
            backendLogs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'log-entry alert'; 
                div.innerHTML = `<span style="opacity: 0.8; color:var(--neon-red)">[CRITICAL THREAT]</span> > ${log}`;
                if(logs) logs.prepend(div);
            });
        }

        setInterval(() => {
            // --- SESSION TIMER LOGIC ---
            const diff = Math.floor((Date.now() - systemStartTime) / 1000);
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            const uptimeEl = document.getElementById('valUptime');
            if(uptimeEl) uptimeEl.innerText = `${h}:${m}:${s}`;

            // --- GRAPH ANIMATION ---
            let packetVolume;
            if (currentRiskScore > 50) packetVolume = 60 + Math.random() * 40; 
            else packetVolume = 10 + Math.random() * 30;

            if(mainChart) {
                mainChart.data.datasets[0].data.shift();
                mainChart.data.datasets[0].data.push(packetVolume);
                const color = (currentRiskScore > 50) ? '#ff0055' : getComputedStyle(document.documentElement).getPropertyValue('--neon-blue');
                mainChart.data.datasets[0].borderColor = color;
                mainChart.update('none');
            }

            // --- 2. BACKGROUND CHATTER ---
            if (Math.random() > 0.8) { 
                const safeEvents = [
                    "Encrypted handshake verified.", "Neural weights recalibrated.",
                    "Shadow node heartbeat stable.", "Packet integrity check: OK.", "Scanning outbound traffic..."
                ];
                const msg = safeEvents[Math.floor(Math.random() * safeEvents.length)];
                const div = document.createElement('div');
                div.className = 'log-entry'; 
                div.innerHTML = `<span style="opacity: 0.3">[SYS_MONITOR]</span> > ${msg}`;
                if(logs) logs.prepend(div);
                if(logs.children.length > 20) logs.removeChild(logs.lastChild);
            }
        }, 800);
    }

    function toggleModule(btn) {
        btn.classList.toggle('active');
        const moduleName = btn.innerText;
        const status = btn.classList.contains('active') ? "ENABLED" : "DISABLED";
        const div = document.createElement('div');
        div.className = 'log-entry ' + (status === "ENABLED" ? "success" : "alert");
        div.innerHTML = `<span style="opacity: 0.3">[SYS]</span> > MODULE ${moduleName}: ${status}`;
        const logs = document.getElementById('logStream');
        if(logs) logs.prepend(div);
    }

    window.addEventListener('resize', () => {
        if(renderer && camera) {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }
    });
    </script>
</body>
</html>